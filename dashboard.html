<!DOCTYPE html>
<!--
  EasyADSB Dashboard
  Version: 1.2.1
  Last Updated: 2025-11-29
  
  An automated multi-feeder setup for ADS-B enthusiasts
  
  Built with:
  - ultrafeeder (github.com/sdr-enthusiasts/docker-adsb-ultrafeeder)
  - fr24feed, piaware, radarbox Docker containers
  - tar1090 web interface
  
  Features:
  - Real-time aircraft tracking
  - Multi-feed station management
  - Dark mode with system auto-detection
  - Stealth mode for screenshots/streaming
  - Mobile responsive design
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyADSB Dashboard v1.2.1</title>
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: white;
            --text-primary: #333;
            --text-secondary: #666;
            --accent-color: #667eea;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --card-bg: #0f3460;
            --text-primary: #e9ecef;
            --text-secondary: #adb5bd;
            --accent-color: #667eea;
            --shadow: rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
            position: relative;
            overflow-x: hidden;
            color: var(--text-primary);
        }

        h2 {
            color: var(--text-primary);
        }

        strong {
            color: var(--text-primary);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 20px 0;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        }

        .header-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: transform 0.2s, box-shadow 0.3s, background 0.3s;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .service-icon {
            font-size: 1.5em;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-online {
            background: #10b981;
            color: white;
        }

        .status-offline {
            background: #ef4444;
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .card-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .card-link {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.9em;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
        }

        .card-link:hover {
            background: #5568d3;
        }

        .card-link.secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .card-link.secondary:hover {
            background: #d1d5db;
        }

        .local-map {
            grid-column: 1 / -1;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: background 0.3s;
        }

        .local-map h2 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .map-frame {
            width: 100%;
            height: 60vh;
            min-height: 300px;
            max-height: 800px;
            border: none;
            border-radius: 8px;
            background: #f3f4f6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        [data-theme="dark"] .stat-box {
            background: rgba(255,255,255,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
        }

        [data-theme="dark"] .stat-value {
            color: #a5b4fc;  /* Lighter purple for dark mode */
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Code elements in tips */
        code {
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }

        [data-theme="dark"] code {
            background: rgba(255,255,255,0.2);
            color: #e9ecef;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px 0;
            color: #999;
            font-size: 0.85em;
            border-top: 1px solid #eee;
        }

        [data-theme="dark"] .footer {
            color: #adb5bd;
            border-top-color: rgba(255,255,255,0.1);
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        [data-theme="dark"] .footer a {
            color: #a5b4fc;
        }

        /* Live Aircraft Table */
        .aircraft-table-wrapper {
            overflow-x: auto;
        }

        .aircraft-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .aircraft-table th {
            text-align: left;
            padding: 8px 6px;
            font-size: 0.75em;
            text-transform: uppercase;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
        }

        .aircraft-table td {
            padding: 8px 6px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            white-space: nowrap;
        }

        .aircraft-table tr:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .aircraft-table .callsign {
            font-weight: 600;
            color: var(--text-primary);
        }

        .aircraft-table .hex-link {
            color: var(--text-secondary);
            font-size: 0.8em;
            text-decoration: none;
            font-family: monospace;
        }

        .aircraft-table .hex-link:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        .aircraft-table .type {
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .aircraft-table .climbing {
            color: #22c55e;
        }

        .aircraft-table .descending {
            color: #f97316;
        }

        .aircraft-table .accelerating {
            color: #3b82f6;  /* Blue for speeding up */
        }

        .aircraft-table .decelerating {
            color: #a855f7;  /* Purple for slowing down */
        }

        .aircraft-table .flag {
            margin-right: 4px;
        }

        /* Freshness/Age colors */
        .age-fresh { color: #22c55e; }      /* Green: 0-10s */
        .age-stale { color: #eab308; }      /* Yellow: 11-30s */
        .age-old { color: #f97316; }        /* Orange: 31-60s */
        .age-lost { color: #ef4444; }       /* Red: 61-120s */
        .age-gone { color: #6b7280; }       /* Gray/dark: 120s+ */

        /* Units Toggle */
        .units-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75em;
            color: var(--text-secondary);
        }

        .units-toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .units-toggle-switch.active {
            background: var(--accent-color);
        }

        .units-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: left 0.2s;
        }

        .units-toggle-switch.active::after {
            left: 18px;
        }

        /* Update Toast */
        .update-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            font-size: 0.9em;
            cursor: default;
        }

        .update-toast.show {
            display: flex;
        }

        .update-toast-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background 0.2s;
        }

        .update-toast-close:hover {
            background: rgba(255,255,255,0.4);
        }

        .update-toast-content {
            position: relative;
        }

        .update-toast-mobile-hint {
            display: none;
            font-size: 0.8em;
            opacity: 0.9;
        }

        .update-tooltip {
            position: absolute;
            bottom: 100%;
            right: 0;
            margin-bottom: 10px;
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        @media (max-width: 768px) {
            .update-toast {
                left: 20px;
                right: 20px;
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
            .update-toast-mobile-hint {
                display: block;
            }
            .update-tooltip {
                display: none;
            }
            .update-toast-close {
                position: absolute;
                top: -8px;
                right: -8px;
            }
        }

        .update-toast:hover .update-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .update-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 20px;
            border: 6px solid transparent;
            border-top-color: var(--card-bg);
        }

        /* Tip boxes */
        .tip-box {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 6px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        [data-theme="dark"] .tip-box {
            background: rgba(102, 126, 234, 0.2);
            color: var(--text-primary);
        }

        /* Station ID boxes */
        .id-box {
            background: rgba(102, 126, 234, 0.1);
            padding: 15px;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        /* Service logs section */
        .service-logs {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 8px 0;
            user-select: none;
        }

        .logs-header:hover {
            opacity: 0.8;
        }

        .logs-toggle {
            font-size: 0.9em;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logs-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .logs-content.expanded {
            max-height: 300px;
        }

        .logs-box {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
            max-height: 250px;
            overflow-y: auto;
            color: #e9ecef;
            line-height: 1.4;
        }

        [data-theme="dark"] .logs-box {
            background: rgba(0,0,0,0.5);
        }

        .log-line {
            padding: 2px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-line.error {
            color: #ff6b6b;
        }

        .log-line.warning {
            color: #ffd93d;
        }

        .log-line.info {
            color: #6bcf7f;
        }

        .restart-btn {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .restart-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }

        /* Station ID boxes */
        .id-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            transition: background 0.3s;
        }

        [data-theme="dark"] .id-box {
            background: rgba(255,255,255,0.1);
        }

        .id-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        [data-theme="dark"] .id-label {
            color: #a5b4fc;
        }

        .id-value {
            font-family: monospace;
            font-size: 0.85em;
            word-break: break-all;
            flex: 1;
            color: var(--text-primary);
        }

        .info-text {
            margin-top: 10px;
            padding: 10px;
            background: #e0e7ff;
            border-radius: 6px;
            font-size: 0.9em;
            color: #4338ca;
        }

        .info-text a {
            color: #4338ca;
            font-weight: 600;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .copy-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 15px 0;
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 1.3em;
                padding-right: 0;
            }
            
            .header p {
                font-size: 0.85em;
            }
            
            .header-buttons {
                position: static !important;
                justify-content: center;
                margin-top: 10px;
            }
            
            .header-btn {
                padding: 8px 12px;
                font-size: 1em;
            }
            
            .card {
                padding: 15px;
            }
            
            /* Stack ID boxes on mobile */
            .station-ids-grid {
                grid-template-columns: 1fr !important;
            }
            
            /* Logger stats 2x2 grid on mobile */
            .logger-stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            /* Live aircraft table scrolls horizontally on mobile */
            .aircraft-table-wrapper {
                overflow-x: auto;
            }
            
            .aircraft-table {
                min-width: 500px;
            }
        }
        
        /* Tablet: 2 columns */
        @media (min-width: 481px) and (max-width: 768px) {
            .station-ids-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* Desktop: 3 columns (default in inline style) */

        .controls-panel {
            grid-column: 1 / -1;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px var(--shadow);
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .controls-panel h2 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-btn.restart {
            background: #10b981;
            color: white;
        }

        .control-btn.restart:hover {
            background: #059669;
        }

        .control-btn.stop {
            background: #ef4444;
            color: white;
        }

        .control-btn.stop:hover {
            background: #dc2626;
        }

        .control-btn.logs {
            background: #3b82f6;
            color: white;
        }

        .control-btn.logs:hover {
            background: #2563eb;
        }

        .control-btn.update {
            background: #8b5cf6;
            color: white;
        }

        .control-btn.update:hover {
            background: #7c3aed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .modal-content {
            background: var(--card-bg);
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        [data-theme="dark"] .modal-header {
            color: var(--text-primary);
        }

        .modal-body {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .modal-body input[type="text"] {
            background: white;
            color: #333;
            border: 1px solid #ddd;
        }

        [data-theme="dark"] .modal-body input[type="text"] {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .modal-body ol {
            color: var(--text-primary);
        }

        .modal-body a {
            color: #667eea;
        }

        [data-theme="dark"] .modal-body a {
            color: #a5b4fc;
        }

        .command-box {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            overflow-x: auto;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .modal-btn.primary:hover {
            background: #5568d3;
        }

        .modal-btn.secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-btn.secondary:hover {
            background: #d1d5db;
        }

        /* Stealth Mode - Hide ONLY sensitive IDs (not stats) */
        .stealth-mode .id-value {
            filter: blur(8px);
            user-select: none;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è EasyADSB Dashboard</h1>
            <p>Monitor your aircraft tracking feeds</p>
            <div class="header-buttons">
                <button onclick="toggleDarkMode()" class="header-btn" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <span id="theme-icon">üåô</span>
                </button>
                <button onclick="toggleStealthMode()" class="header-btn" title="Stealth Mode - Hide IDs for screenshots" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                    <span id="stealth-icon">üôà</span>
                </button>
            </div>
        </div>

        <div class="grid">
            <!-- Local tar1090 Map -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="service-icon">üó∫Ô∏è</span>
                        Local Map
                    </span>
                    <span class="status-badge status-online">
                        <span class="status-dot"></span>
                        Active
                    </span>
                </div>
                <div class="card-content">
                    View live aircraft in your area.
                    <div class="card-links">
                        <a href="#" id="tar1090-link" target="_blank" class="card-link">Open Map</a>
                        <a href="#" id="graphs-link" target="_blank" class="card-link secondary">Graphs</a>
                    </div>
                </div>
            </div>

            <!-- ADSBexchange -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="service-icon">üåê</span>
                        ADSBexchange
                    </span>
                    <span class="status-badge status-online">
                        <span class="status-dot"></span>
                        Broadcasting
                    </span>
                </div>
                <div class="card-content">
                    Global unfiltered flight tracking.
                    <div class="card-links">
                        <a href="https://www.adsbexchange.com/myip/" target="_blank" class="card-link">My Stats</a>
                        <button onclick="openAdsbxMap()" class="card-link secondary">My Feed</button>
                        <button onclick="openAdsbxCoverage()" class="card-link secondary">Coverage</button>
                    </div>
                    <div class="card-links" style="margin-top: 8px;">
                        <button onclick="openAdsbxLeaderboard()" class="card-link secondary">Leaderboard</button>
                        <button onclick="openAdsbxMLATSync()" class="card-link secondary">MLAT Sync</button>
                    </div>
                </div>
            </div>

            <!-- ADSB.lol -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="service-icon">üì°</span>
                        ADSB.lol
                    </span>
                    <span class="status-badge status-online">
                        <span class="status-dot"></span>
                        Broadcasting
                    </span>
                </div>
                <div class="card-content">
                    Community ADS-B aggregator.
                    <div class="card-links">
                        <a href="https://adsb.lol" target="_blank" class="card-link">Global Map</a>
                        <a href="https://mlat.adsb.lol/" target="_blank" class="card-link secondary">MLAT Map</a>
                    </div>
                </div>
            </div>

            <!-- FlightAware -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="service-icon">üõ´</span>
                        FlightAware
                    </span>
                    <span class="status-badge status-online">
                        <span class="status-dot"></span>
                        Broadcasting
                    </span>
                </div>
                <div class="card-content">
                    Leading flight tracking service.
                    <div class="info-text" id="piaware-claim-msg" style="display: none;">
                        üí° <a href="https://flightaware.com/adsb/piaware/claim" target="_blank">Claim your feeder</a>
                        <button onclick="dismissClaimMsg()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; margin-left: 10px;" title="Dismiss">‚úï</button>
                    </div>
                    <div class="card-links">
                        <button onclick="openPiawareStats()" class="card-link">My Stats</button>
                        <a href="https://www.flightaware.com/live/map" target="_blank" class="card-link secondary">SkyAware Map</a>
                    </div>
                </div>
            </div>

            <!-- FlightRadar24 -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="service-icon">üìç</span>
                        FlightRadar24
                    </span>
                    <span class="status-badge status-online">
                        <span class="status-dot"></span>
                        Broadcasting
                    </span>
                </div>
                <div class="card-content">
                    Popular flight tracker.
                    <div class="card-links">
                        <a href="https://www.flightradar24.com/account/data-sharing" target="_blank" class="card-link">My Feeders</a>
                    </div>
                </div>
            </div>

            <!-- RadarBox -->
            <div class="card">
                <div class="card-header">
                    <span class="card-title">
                        <span class="service-icon">üì∂</span>
                        RadarBox
                    </span>
                    <span class="status-badge status-online">
                        <span class="status-dot"></span>
                        Broadcasting
                    </span>
                </div>
                <div class="card-content">
                    Aviation data platform.
                    <div class="card-links">
                        <button onclick="openRadarBoxStation()" class="card-link">My Station</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Embedded Local Map -->
        <div class="local-map">
            <h2>üó∫Ô∏è Live Aircraft Map</h2>
            <iframe class="map-frame" id="map-iframe" src="about:blank"></iframe>
        </div>

        <!-- Quick Stats -->
        <div class="card" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div>
                    <h2 style="margin: 0;">üìä Quick Stats</h2>
                    <span style="font-size: 0.75em; color: var(--text-secondary);">Live data from your receiver</span>
                </div>
                <span id="stats-update-time" style="font-size: 0.75em; color: var(--text-secondary);"></span>
            </div>
            <div class="stats-grid">
                <div class="stat-box" style="border-left: 4px solid #22c55e;">
                    <div class="stat-value" id="aircraft-count">-</div>
                    <div class="stat-label">‚úàÔ∏è Aircraft Now</div>
                </div>
                <div class="stat-box" style="border-left: 4px solid #f97316;">
                    <div class="stat-value" id="messages-count">-</div>
                    <div class="stat-label">üì° Messages/sec</div>
                </div>
                <div class="stat-box" style="border-left: 4px solid #3b82f6;">
                    <div class="stat-value" id="range-max">-</div>
                    <div class="stat-label" style="cursor: pointer;" onclick="toggleRangeUnits()" title="Click to change units">üìè Max Range (<span id="range-unit">nm</span>)</div>
                </div>
            </div>
        </div>

        <!-- Live Aircraft -->
        <div class="card" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">üì° Live Aircraft <span id="aircraft-count-badge" style="font-size: 0.5em; background: rgba(102,126,234,0.2); padding: 4px 10px; border-radius: 12px; vertical-align: middle;"></span></h2>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="units-toggle">
                        <span>kt/nm</span>
                        <div id="units-toggle-switch" class="units-toggle-switch" onclick="toggleUnits()" title="Toggle units"></div>
                        <span>mph/mi</span>
                    </div>
                    <span id="aircraft-update-time" style="font-size: 0.75em; color: var(--text-secondary);"></span>
                </div>
            </div>
            <div class="aircraft-table-wrapper">
                <div id="live-aircraft" style="max-height: 350px; overflow-y: auto;">
                    <div style="color: var(--text-secondary); text-align: center; padding: 20px;">
                        Loading aircraft data...
                    </div>
                </div>
            </div>
        </div>

        <!-- Station IDs Reference -->
        <div class="card" style="margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">üîë Your Station IDs</h2>
                <button class="copy-btn" onclick="copyAllIDs()" title="Copy all IDs" style="padding: 8px 12px; font-size: 0.9em;">üìã Copy All</button>
            </div>
            <div style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 15px;">
                Keep these handy for linking accounts and troubleshooting
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;" class="station-ids-grid">
                <div class="id-box">
                    <div class="id-label">ADSBexchange UUID</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="id-value" id="ref-adsbx">-</div>
                        <button class="copy-btn" onclick="copyToClipboard('ref-adsbx')" title="Copy to clipboard">üìã</button>
                    </div>
                </div>
                <div class="id-box">
                    <div class="id-label">ADSB.lol UUID</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="id-value" id="ref-adsblol">-</div>
                        <button class="copy-btn" onclick="copyToClipboard('ref-adsblol')" title="Copy to clipboard">üìã</button>
                    </div>
                </div>
                <div class="id-box">
                    <div class="id-label">RadarBox Key</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="id-value" id="ref-rb-key">-</div>
                        <button class="copy-btn" onclick="copyToClipboard('ref-rb-key')" title="Copy to clipboard">üìã</button>
                    </div>
                </div>
                <div class="id-box">
                    <div class="id-label">RadarBox Serial</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="id-value" id="ref-rb-serial">-</div>
                        <button class="copy-btn" onclick="copyToClipboard('ref-rb-serial')" title="Copy to clipboard">üìã</button>
                    </div>
                </div>
                <div class="id-box">
                    <div class="id-label">FlightRadar24 Key</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="id-value" id="ref-fr24">-</div>
                        <button class="copy-btn" onclick="copyToClipboard('ref-fr24')" title="Copy to clipboard">üìã</button>
                    </div>
                </div>
                <div class="id-box">
                    <div class="id-label">PiAware ID</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="id-value" id="ref-piaware">-</div>
                        <button class="copy-btn" onclick="copyToClipboard('ref-piaware')" title="Copy to clipboard">üìã</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Flight Logger Section -->
        <div class="card" style="margin-top: 20px;" id="logger-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">üìº Flight Logger</h2>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span id="logger-status" style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: var(--text-secondary); color: white;">Checking...</span>
                    <button id="logger-toggle-btn" class="copy-btn" onclick="toggleLogger()" style="padding: 6px 12px; font-size: 12px;" disabled>
                        ‚è∏Ô∏è Pause
                    </button>
                </div>
            </div>
            
            <!-- Logger Disabled Message (shown when logger not running) -->
            <div id="logger-disabled" style="display: none; text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">üìº</div>
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">Flight Logger Not Enabled</div>
                <div style="font-size: 14px; color: var(--text-secondary);">Run <code style="background: var(--card-bg); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border-color);">./setup.sh</code> and enable flight logging to track your flight history.</div>
            </div>
            
            <!-- Logger Stats (shown when running) -->
            <div id="logger-stats" style="display: none;">
                <!-- Stats Grid -->
                <div class="logger-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; margin-bottom: 20px;">
                    <div class="id-box" style="text-align: center; padding: 15px;">
                        <div id="logger-total" style="font-size: 22px; font-weight: 700; color: #667eea;">0</div>
                        <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px;">Positions</div>
                    </div>
                    <div class="id-box" style="text-align: center; padding: 15px;">
                        <div id="logger-aircraft" style="font-size: 22px; font-weight: 700; color: #28a745;">0</div>
                        <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px;">Aircraft</div>
                    </div>
                    <div class="id-box" style="text-align: center; padding: 15px;">
                        <div id="logger-flights" style="font-size: 22px; font-weight: 700; color: #fd7e14;">0</div>
                        <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px;">Flights</div>
                    </div>
                    <div class="id-box" style="text-align: center; padding: 15px;">
                        <div id="logger-storage" style="font-size: 22px; font-weight: 700; color: #17a2b8;">0 MB</div>
                        <div style="font-size: 10px; color: var(--text-secondary); text-transform: uppercase; margin-top: 4px;">Storage</div>
                    </div>
                </div>
                
                <!-- Storage Bar -->
                <div style="margin-bottom: 20px; padding: 15px; background: var(--bg-color); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                        <span>Storage Used</span>
                        <span id="logger-storage-text">0 MB / 0 GB free</span>
                    </div>
                    <div style="height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                        <div id="logger-storage-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;"></div>
                    </div>
                    <div id="logger-estimate" style="font-size: 11px; color: var(--text-secondary); margin-top: 8px;">
                        Estimating storage requirements...
                    </div>
                </div>
                
                <!-- Date Range -->
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; text-align: center;">
                    üìÖ <span id="logger-date-range">No data yet</span>
                </div>
                
                <!-- Settings Box -->
                <div style="padding: 15px; background: var(--bg-color); border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px; font-weight: 600;">‚öôÔ∏è Settings</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;">
                        <div style="min-width: 110px;">
                            <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Sample Rate</label>
                            <select id="logger-interval" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="5">5 sec</option>
                                <option value="10">10 sec</option>
                                <option value="15">15 sec</option>
                                <option value="30">30 sec</option>
                                <option value="60">60 sec</option>
                            </select>
                        </div>
                        <div style="min-width: 100px;">
                            <label style="display: block; font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Keep Data</label>
                            <select id="logger-retention" style="width: 100%; padding: 6px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 13px; background: var(--card-bg); color: var(--text-primary);">
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                                <option value="30">30 days</option>
                                <option value="0">Forever</option>
                            </select>
                        </div>
                        <button id="logger-save-btn" class="copy-btn" onclick="saveLoggerSettings()" style="padding: 6px 14px; font-size: 13px;">
                            üíæ Save
                        </button>
                        <span id="logger-save-status" style="font-size: 11px; color: var(--text-secondary);"></span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <button class="copy-btn" onclick="exportLogs('csv')" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none;">
                        üì• Export CSV
                    </button>
                    <button class="copy-btn" onclick="exportLogs('json')" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%); color: white; border: none;">
                        üì• Export JSON
                    </button>
                    <button class="copy-btn" onclick="clearLogs()" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none;">
                        üóëÔ∏è Clear Logs
                    </button>
                </div>
            </div>
        </div>

        <!-- Version Footer -->
        <div class="footer">
            EasyADSB v1.2.1 | 
            <a href="https://github.com/datboip/easyadsb" target="_blank">‚≠ê GitHub</a> | 
            Built with <a href="https://github.com/sdr-enthusiasts/docker-adsb-ultrafeeder" target="_blank">ultrafeeder</a>
        </div>
    </div>

    <!-- Update Toast -->
    <div id="update-toast" class="update-toast">
        <div class="update-toast-content">
            <span>‚¨ÜÔ∏è <span id="update-version">v1.2.2</span> available</span>
            <div class="update-toast-mobile-hint">Run ./setup.sh option 6</div>
            <div class="update-tooltip">
                Run <strong>./setup.sh</strong> option 6 to update
            </div>
        </div>
        <button class="update-toast-close" onclick="dismissUpdate()" title="Dismiss">‚úï</button>
    </div>

    <!-- Short ID Input Modal -->
    <div id="shortIdModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üîë ADSBexchange Short ID</div>
            <div class="modal-body">
                <p>To view your coverage map, you need your ADSBexchange <strong>Short ID</strong> (Feed UID).</p>
                <p style="margin-top: 10px;"><strong>How to find it:</strong></p>
                <ol style="margin-left: 20px; margin-top: 10px;">
                    <li>Go to <a href="https://www.adsbexchange.com/myip/" target="_blank" style="color: #667eea;">adsbexchange.com/myip</a></li>
                    <li>Look for <strong>"Feed UID"</strong> (example: BtPKRlTdmKjr)</li>
                    <li>Enter it below (it will be saved)</li>
                </ol>
                <div style="margin-top: 20px;">
                    <label for="shortIdInput" style="display: block; margin-bottom: 8px; font-weight: 600;">Short ID (Feed UID):</label>
                    <input type="text" id="shortIdInput" placeholder="BtPKRlTdmKjr" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: monospace;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeShortIdModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveShortId()">Save & Open</button>
            </div>
        </div>
    </div>

    <script src="dashboard-config.js"></script>
    
    <script>
        // Dark Mode Toggle
        function toggleDarkMode() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            const icon = document.getElementById('theme-icon');
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            icon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Stealth Mode - Hide Station IDs for screenshots/streaming
        function toggleStealthMode() {
            const body = document.body;
            const icon = document.getElementById('stealth-icon');
            const isStealthMode = body.classList.contains('stealth-mode');
            
            if (isStealthMode) {
                body.classList.remove('stealth-mode');
                icon.textContent = 'üëÅÔ∏è';
                localStorage.setItem('stealthMode', 'false');
            } else {
                body.classList.add('stealth-mode');
                icon.textContent = 'üîí';
                localStorage.setItem('stealthMode', 'true');
            }
        }

        // Load saved theme or detect system preference
        let savedTheme = localStorage.getItem('theme');
        if (!savedTheme) {
            // Auto-detect from system
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                savedTheme = 'dark';
            } else {
                savedTheme = 'light';
            }
        }
        
        if (savedTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
        }

        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            if (text === '-' || text === 'Not configured' || text === 'Generated on first connect') {
                return; // Don't copy placeholder text
            }
            
            // Try modern clipboard API first
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopyFeedback(element);
                }).catch(err => {
                    // Fallback if clipboard API fails
                    fallbackCopy(text, element);
                });
            } else {
                // Fallback for non-HTTPS or older browsers
                fallbackCopy(text, element);
            }
        }
        
        // Fallback copy method using textarea
        function fallbackCopy(text, element) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showCopyFeedback(element);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard. Text: ' + text);
            }
            
            document.body.removeChild(textarea);
        }
        
        // Show copy success feedback
        function showCopyFeedback(element) {
            const btn = element.parentElement.querySelector('.copy-btn');
            const originalText = btn.textContent;
            btn.textContent = '‚úì';
            btn.style.background = '#10b981';
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        }

        // Copy all IDs to clipboard
        function copyAllIDs() {
            const ids = {
                'ADSBexchange UUID': document.getElementById('ref-adsbx').textContent,
                'ADSB.lol UUID': document.getElementById('ref-adsblol').textContent,
                'RadarBox Key': document.getElementById('ref-rb-key').textContent,
                'RadarBox Serial': document.getElementById('ref-rb-serial').textContent,
                'FlightRadar24 Key': document.getElementById('ref-fr24').textContent,
                'PiAware ID': document.getElementById('ref-piaware').textContent
            };
            
            let text = 'EasyADSB Station IDs:\n\n';
            for (const [label, value] of Object.entries(ids)) {
                if (value && value !== '-' && !value.includes('Not configured') && !value.includes('Check logs')) {
                    text += `${label}: ${value}\n`;
                }
            }
            
            // Use fallback copy method for compatibility
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('‚úì All IDs copied to clipboard!');
                }).catch(err => {
                    fallbackCopyAll(text);
                });
            } else {
                fallbackCopyAll(text);
            }
        }
        
        // Fallback for copying all IDs
        function fallbackCopyAll(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                alert('‚úì All IDs copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard');
            }
            
            document.body.removeChild(textarea);
        }

        // Detect hostname and build tar1090 URL
        const hostname = window.location.hostname;
        const tar1090URL = `http://${hostname}:8080/`;
        
        // Update tar1090 links
        document.getElementById('tar1090-link').href = tar1090URL;
        document.getElementById('graphs-link').href = `${tar1090URL}graphs1090/`;
        
        // Load the map
        document.getElementById('map-iframe').src = tar1090URL;

        // Initialize config
        let config = {};
        
        // Try to load from generated config file
        if (typeof window.FEEDER_CONFIG !== 'undefined') {
            config = { ...window.FEEDER_CONFIG };
        }
        
        // Load user config from localStorage as fallback
        const savedLocal = localStorage.getItem('adsbConfig');
        if (savedLocal) {
            const localConfig = JSON.parse(savedLocal);
            // Merge localStorage values (for backwards compatibility)
            if (localConfig.adsbxShortID) config.adsbxShortID = localConfig.adsbxShortID;
        }

        // Load user config from server (will override localStorage)
        const LOGGER_PORT = window.FEEDER_CONFIG?.loggerPort || 8082;
        async function loadUserConfig() {
            try {
                const response = await fetch(`http://${location.hostname}:${LOGGER_PORT}/api/userconfig`);
                if (response.ok) {
                    const userConfig = await response.json();
                    // Merge server config into our config
                    if (userConfig.adsbxShortID) config.adsbxShortID = userConfig.adsbxShortID;
                    console.log('Loaded user config from server:', userConfig);
                }
            } catch (e) {
                console.log('Could not load user config from server, using localStorage');
            }
        }
        loadUserConfig();

        // Save user config to server
        async function saveUserConfig(key, value) {
            try {
                const response = await fetch(`http://${location.hostname}:${LOGGER_PORT}/api/userconfig`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [key]: value })
                });
                if (response.ok) {
                    console.log(`Saved ${key} to server`);
                    return true;
                }
            } catch (e) {
                console.log('Could not save to server, saving to localStorage only');
            }
            return false;
        }

        // ADSBexchange Map - requires Short ID
        function openAdsbxMap() {
            let shortId = config.adsbxShortID;
            if (!shortId || shortId === '') {
                showShortIdModal('map');
            } else {
                window.open(`https://globe.adsbexchange.com/?feed=${shortId}`, '_blank');
            }
        }

        // ADSBexchange Coverage Stats - requires Short ID
        function openAdsbxCoverage() {
            let shortId = config.adsbxShortID;
            if (!shortId || shortId === '') {
                showShortIdModal('coverage');
            } else {
                const timestamp = Date.now();
                window.open(`https://www.adsbexchange.com/api/feeders/?feed=${shortId}&t=${timestamp}`, '_blank');
            }
        }

        // ADSBexchange Leaderboard - uses Feeder Name or Short ID
        function openAdsbxLeaderboard() {
            let feederName = config.feederName;
            let shortId = config.adsbxShortID;
            
            if (feederName && feederName !== '') {
                window.open(`https://globe.adsbexchange.com/leaderboard/?feed=${feederName}`, '_blank');
            } else if (shortId && shortId !== '') {
                window.open(`https://globe.adsbexchange.com/leaderboard/?feed=${shortId}`, '_blank');
            } else {
                showShortIdModal('leaderboard');
            }
        }

        // ADSBexchange MLAT Sync Status - uses Feeder Name
        function openAdsbxMLATSync() {
            let feederName = config.feederName;
            
            if (feederName && feederName !== '') {
                window.open(`https://map.adsbexchange.com/sync/feeder.html?4&${feederName}`, '_blank');
            } else {
                alert('Feeder name not configured.\n\nRun ./setup.sh and reconfigure to set your feeder name.');
            }
        }

        // FlightAware Stats - uses PiAware ID
        function openPiawareStats() {
            let piawareID = config.piawareID;
            if (!piawareID || piawareID === 'YOUR-PIAWARE-FEEDER-ID' || piawareID === '') {
                alert('PiAware ID not configured.\n\nYour PiAware ID is in your .env file as PIAWARE_FEEDER_ID');
            } else {
                window.open(`https://flightaware.com/adsb/stats/user/${piawareID}`, '_blank');
            }
        }

        // Dismiss claim feeder message
        function dismissClaimMsg() {
            document.getElementById('piaware-claim-msg').style.display = 'none';
            localStorage.setItem('piaware-claim-dismissed', 'true');
        }

        // Open coverage links - prompt for key if not available
        function openCoverageLink(service) {
            let key, url;
            
            switch(service) {
                case 'adsbx':
                    // ADSBexchange coverage requires "Short ID" not UUID
                    // Short IDs look like: BtPKRlTdmKjr (from myip page)
                    let shortId = config.adsbxShortID;
                    
                    if (!shortId || shortId === '') {
                        showShortIdModal();
                    } else {
                        window.open(`https://www.adsbexchange.com/api/feeders/?feed=${shortId}`, '_blank');
                    }
                    break;
                    
                case 'piaware':
                    key = config.piawareID;
                    if (!key || key === 'YOUR-PIAWARE-FEEDER-ID' || key === '') {
                        key = prompt('Enter your FlightAware username:\n\n(Your username from flightaware.com)');
                        if (key) {
                            config.piawareID = key;
                            localStorage.setItem('adsbConfig', JSON.stringify(config));
                        }
                    }
                    if (key && key !== 'YOUR-PIAWARE-FEEDER-ID') {
                        window.open(`https://flightaware.com/adsb/stats/user/${key}`, '_blank');
                    }
                    break;
            }
        }
        
        // RadarBox station link using serial
        function openRadarBoxStation() {
            let serial = config.radarboxSerial;
            
            if (!serial || serial === '' || serial === 'YOUR-RADARBOX-SERIAL') {
                serial = prompt('Enter your RadarBox station serial:\n\n(Find in Station IDs section below or in logs: docker compose logs radarbox | grep "serial")');
                if (serial) {
                    config.radarboxSerial = serial;
                    localStorage.setItem('adsbConfig', JSON.stringify(config));
                    document.getElementById('ref-rb-serial').textContent = serial;
                }
            }
            
            if (serial && serial !== 'YOUR-RADARBOX-SERIAL') {
                window.open(`https://www.radarbox.com/stations/${serial}`, '_blank');
            }
        }

        // Show command modal
        // Short ID Modal Functions
        let shortIdModalContext = 'coverage';  // Default context
        
        function showShortIdModal(context = 'coverage') {
            shortIdModalContext = context;  // Save context for later
            document.getElementById('shortIdModal').classList.add('active');
            document.getElementById('shortIdInput').value = config.adsbxShortID || '';
            // Focus the input
            setTimeout(() => document.getElementById('shortIdInput').focus(), 100);
        }

        function closeShortIdModal() {
            document.getElementById('shortIdModal').classList.remove('active');
        }

        function saveShortId() {
            const shortId = document.getElementById('shortIdInput').value.trim();
            if (shortId) {
                config.adsbxShortID = shortId;
                
                // Save to localStorage (fallback)
                localStorage.setItem('adsbConfig', JSON.stringify(config));
                
                // Save to server (persists across browsers)
                saveUserConfig('adsbxShortID', shortId);
                
                closeShortIdModal();
                
                // Open appropriate URL based on context
                const timestamp = Date.now();
                if (shortIdModalContext === 'map') {
                    window.open(`https://globe.adsbexchange.com/?feed=${shortId}`, '_blank');
                } else if (shortIdModalContext === 'leaderboard') {
                    window.open(`https://globe.adsbexchange.com/leaderboard/?feed=${shortId}`, '_blank');
                } else {
                    window.open(`https://www.adsbexchange.com/api/feeders/?feed=${shortId}&t=${timestamp}`, '_blank');
                }
            } else {
                alert('Please enter a Short ID');
            }
        }

        // Close Short ID modal on background click
        document.getElementById('shortIdModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeShortIdModal();
            }
        });

        // Handle Enter key in Short ID input
        document.getElementById('shortIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                saveShortId();
            }
        });

        // Fetch stats from tar1090
        // Track previous values for rate calculation
        let prevMessages = null;
        let prevMsgTime = null;
        let prevAircraftSpeeds = {}; // Track previous speeds by hex for trend arrows
        let rangeUnit = localStorage.getItem('rangeUnit') || 'nm'; // nm, mi, km

        function toggleRangeUnits() {
            const units = ['nm', 'mi', 'km'];
            const currentIndex = units.indexOf(rangeUnit);
            rangeUnit = units[(currentIndex + 1) % units.length];
            localStorage.setItem('rangeUnit', rangeUnit);
            document.getElementById('range-unit').textContent = rangeUnit;
            updateStats(); // Refresh with new units
        }

        // Initialize range unit display
        document.getElementById('range-unit').textContent = rangeUnit;

        async function updateStats() {
            try {
                const response = await fetch(`${tar1090URL}data/aircraft.json`);
                const data = await response.json();
                
                const aircraftCount = data.aircraft?.length || 0;
                document.getElementById('aircraft-count').textContent = aircraftCount;
                
                // Calculate actual messages per second
                const currentMessages = data.messages || 0;
                const currentTime = Date.now();
                
                if (prevMessages !== null && prevMsgTime !== null) {
                    const elapsed = (currentTime - prevMsgTime) / 1000; // seconds
                    if (elapsed > 0) {
                        const rate = (currentMessages - prevMessages) / elapsed;
                        if (rate >= 1000) {
                            document.getElementById('messages-count').textContent = (rate / 1000).toFixed(1) + 'k';
                        } else {
                            document.getElementById('messages-count').textContent = Math.round(rate);
                        }
                    }
                } else {
                    document.getElementById('messages-count').textContent = '-';
                }
                prevMessages = currentMessages;
                prevMsgTime = currentTime;
                
                // Calculate max range with unit conversion
                let maxRange = 0;
                data.aircraft?.forEach(ac => {
                    if (ac.seen_pos < 60 && ac.r_dst) {
                        maxRange = Math.max(maxRange, ac.r_dst);
                    }
                });
                
                // Convert range based on selected unit
                let displayRange = maxRange;
                if (rangeUnit === 'mi') {
                    displayRange = maxRange * 1.15078; // nm to miles
                } else if (rangeUnit === 'km') {
                    displayRange = maxRange * 1.852; // nm to km
                }
                document.getElementById('range-max').textContent = displayRange > 0 ? displayRange.toFixed(1) : '-';
                
                // Update timestamp
                const now = new Date();
                const seconds = Math.floor((Date.now() - window.lastStatsUpdate) / 1000) || 0;
                window.lastStatsUpdate = Date.now();
                document.getElementById('stats-update-time').textContent = seconds < 2 ? 'Just now' : `Updated ${seconds}s ago`;
                
                // Update feed status - if we're getting data, feeds are working
                if (aircraftCount > 0) {
                    updateFeedStatus('online');
                }
            } catch (e) {
                console.log('Could not fetch stats:', e);
                updateFeedStatus('offline');
            }
        }

        // Update feed status indicators
        function updateFeedStatus(status) {
            const badges = document.querySelectorAll('.status-badge');
            badges.forEach(badge => {
                if (status === 'online') {
                    badge.classList.remove('status-offline');
                    badge.classList.add('status-online');
                    badge.innerHTML = '<span class="status-dot"></span>Broadcasting';
                } else {
                    badge.classList.remove('status-online');
                    badge.classList.add('status-offline');
                    badge.innerHTML = '<span class="status-dot"></span>Checking...';
                }
            });
        }

        // Populate reference IDs
        function updateReferenceIDs() {
            document.getElementById('ref-adsbx').textContent = config.adsbxUUID || 'Not configured';
            document.getElementById('ref-adsblol').textContent = config.adsbLolUUID || config.adsblolUUID || 'Not configured';  // Support both naming
            document.getElementById('ref-rb-key').textContent = config.radarboxKey || 'Not configured';
            
            // RadarBox Serial - show helper if not available
            const rbSerialEl = document.getElementById('ref-rb-serial');
            if (config.radarboxSerial && config.radarboxSerial !== '' && config.radarboxSerial !== 'YOUR-RADARBOX-KEY') {
                rbSerialEl.textContent = config.radarboxSerial;
            } else {
                rbSerialEl.innerHTML = '<span style="color: var(--text-secondary); font-size: 0.85em;">Check logs: docker compose logs radarbox | grep "serial"</span>';
            }
            
            document.getElementById('ref-fr24').textContent = config.fr24Key || 'Not configured';
            document.getElementById('ref-piaware').textContent = config.piawareID || 'Not configured';
        }

        // Country flag lookup from ICAO hex prefix
        function getCountryFlag(hex) {
            if (!hex) return '';
            const h = hex.toUpperCase();
            
            // Comprehensive ICAO hex ranges (official allocations)
            // Source: ICAO Doc 8585 / Various aviation databases
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // AFRICA (0x000000 - 0x0FFFFF partial)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (h >= '004000' && h <= '0043FF') return 'üáøüáº';  // Zimbabwe
            if (h >= '006000' && h <= '006FFF') return 'üá≤üáø';  // Mozambique
            if (h >= '008000' && h <= '00FFFF') return 'üáøüá¶';  // South Africa
            if (h >= '010000' && h <= '017FFF') return 'üá™üá¨';  // Egypt
            if (h >= '018000' && h <= '01FFFF') return 'üá±üáæ';  // Libya
            if (h >= '020000' && h <= '027FFF') return 'üá≤üá¶';  // Morocco
            if (h >= '028000' && h <= '02FFFF') return 'üáπüá≥';  // Tunisia
            if (h >= '030000' && h <= '0303FF') return 'üáßüáº';  // Botswana
            if (h >= '032000' && h <= '032FFF') return 'üáßüáÆ';  // Burundi
            if (h >= '034000' && h <= '034FFF') return 'üá®üá≤';  // Cameroon
            if (h >= '036000' && h <= '036FFF') return 'üá®üá¨';  // Congo
            if (h >= '038000' && h <= '038FFF') return 'üá®üáÆ';  // C√¥te d'Ivoire
            if (h >= '03E000' && h <= '03EFFF') return 'üá¨üá¶';  // Gabon
            if (h >= '040000' && h <= '040FFF') return 'üá™üáπ';  // Ethiopia
            if (h >= '042000' && h <= '042FFF') return 'üá¨üá∂';  // Equatorial Guinea
            if (h >= '044000' && h <= '044FFF') return 'üá¨üá≠';  // Ghana
            if (h >= '046000' && h <= '046FFF') return 'üá¨üá≥';  // Guinea
            if (h >= '048000' && h <= '0483FF') return 'üá¨üáº';  // Guinea-Bissau
            if (h >= '04A000' && h <= '04A3FF') return 'üá±üá∏';  // Lesotho
            if (h >= '04C000' && h <= '04CFFF') return 'üá∞üá™';  // Kenya
            if (h >= '050000' && h <= '050FFF') return 'üá±üá∑';  // Liberia
            if (h >= '054000' && h <= '054FFF') return 'üá≤üá¨';  // Madagascar
            if (h >= '058000' && h <= '058FFF') return 'üá≤üáº';  // Malawi
            if (h >= '05A000' && h <= '05A3FF') return 'üá≤üáª';  // Maldives
            if (h >= '05C000' && h <= '05CFFF') return 'üá≤üá±';  // Mali
            if (h >= '05E000' && h <= '05E3FF') return 'üá≤üá∑';  // Mauritania
            if (h >= '060000' && h <= '0603FF') return 'üá≤üá∫';  // Mauritius
            if (h >= '062000' && h <= '062FFF') return 'üá≥üá™';  // Niger
            if (h >= '064000' && h <= '064FFF') return 'üá≥üá¨';  // Nigeria
            if (h >= '068000' && h <= '068FFF') return 'üá∫üá¨';  // Uganda
            if (h >= '06A000' && h <= '06A3FF') return 'üá∂üá¶';  // Qatar
            if (h >= '06C000' && h <= '06CFFF') return 'üá®üá´';  // Central African Republic
            if (h >= '06E000' && h <= '06EFFF') return 'üá∑üáº';  // Rwanda
            if (h >= '070000' && h <= '070FFF') return 'üá∏üá≥';  // Senegal
            if (h >= '074000' && h <= '0743FF') return 'üá∏üá®';  // Seychelles
            if (h >= '076000' && h <= '0763FF') return 'üá∏üá±';  // Sierra Leone
            if (h >= '078000' && h <= '078FFF') return 'üá∏üá¥';  // Somalia
            if (h >= '07A000' && h <= '07A3FF') return 'üá∏üáø';  // Eswatini
            if (h >= '07C000' && h <= '07CFFF') return 'üá∏üá©';  // Sudan
            if (h >= '080000' && h <= '080FFF') return 'üáπüáø';  // Tanzania
            if (h >= '084000' && h <= '084FFF') return 'üáπüá©';  // Chad
            if (h >= '088000' && h <= '088FFF') return 'üáπüá¨';  // Togo
            if (h >= '08A000' && h <= '08AFFF') return 'üáøüá≤';  // Zambia
            if (h >= '08C000' && h <= '08CFFF') return 'üá®üá©';  // DR Congo
            if (h >= '090000' && h <= '090FFF') return 'üá¶üá¥';  // Angola
            if (h >= '094000' && h <= '0943FF') return 'üáßüáØ';  // Benin
            if (h >= '096000' && h <= '0963FF') return 'üá®üáª';  // Cape Verde
            if (h >= '098000' && h <= '0983FF') return 'üá©üáØ';  // Djibouti
            if (h >= '09A000' && h <= '09AFFF') return 'üá¨üá≤';  // Gambia
            if (h >= '09C000' && h <= '09CFFF') return 'üáßüá´';  // Burkina Faso
            if (h >= '09E000' && h <= '09E3FF') return 'üá∏üáπ';  // S√£o Tom√©
            if (h >= '0A0000' && h <= '0A7FFF') return 'üá©üáø';  // Algeria
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // AMERICAS - CARIBBEAN & CENTRAL (0x0A8000 - 0x0FFFFF)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (h >= '0A8000' && h <= '0A8FFF') return 'üáßüá∏';  // Bahamas
            if (h >= '0AA000' && h <= '0AA3FF') return 'üáßüáß';  // Barbados
            if (h >= '0AB000' && h <= '0AB3FF') return 'üáßüáø';  // Belize
            if (h >= '0AC000' && h <= '0ACFFF') return 'üá®üá¥';  // Colombia
            if (h >= '0AE000' && h <= '0AEFFF') return 'üá®üá∑';  // Costa Rica
            if (h >= '0B0000' && h <= '0B0FFF') return 'üá®üá∫';  // Cuba
            if (h >= '0B2000' && h <= '0B2FFF') return 'üá∏üáª';  // El Salvador
            if (h >= '0B4000' && h <= '0B4FFF') return 'üá¨üáπ';  // Guatemala
            if (h >= '0B6000' && h <= '0B6FFF') return 'üá¨üáæ';  // Guyana
            if (h >= '0B8000' && h <= '0B8FFF') return 'üá≠üáπ';  // Haiti
            if (h >= '0BA000' && h <= '0BAFFF') return 'üá≠üá≥';  // Honduras
            if (h >= '0BC000' && h <= '0BCFFF') return 'üáªüá®';  // St Vincent
            if (h >= '0BE000' && h <= '0BEFFF') return 'üáØüá≤';  // Jamaica
            if (h >= '0C0000' && h <= '0C0FFF') return 'üá≥üáÆ';  // Nicaragua
            if (h >= '0C2000' && h <= '0C2FFF') return 'üáµüá¶';  // Panama
            if (h >= '0C4000' && h <= '0C4FFF') return 'üá©üá¥';  // Dominican Republic
            if (h >= '0C6000' && h <= '0C6FFF') return 'üáπüáπ';  // Trinidad and Tobago
            if (h >= '0C8000' && h <= '0C8FFF') return 'üá∏üá∑';  // Suriname
            if (h >= '0CA000' && h <= '0CA3FF') return 'üá¶üá¨';  // Antigua and Barbuda
            if (h >= '0CC000' && h <= '0CC3FF') return 'üá¨üá©';  // Grenada
            if (h >= '0D0000' && h <= '0D7FFF') return 'üá≤üáΩ';  // Mexico
            if (h >= '0D8000' && h <= '0DFFFF') return 'üáªüá™';  // Venezuela
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // RUSSIA & CIS (0x100000 - 0x1FFFFF)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (h >= '100000' && h <= '1FFFFF') return 'üá∑üá∫';  // Russia
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // EUROPE (0x300000 - 0x5FFFFF)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (h >= '300000' && h <= '33FFFF') return 'üáÆüáπ';  // Italy
            if (h >= '340000' && h <= '37FFFF') return 'üá™üá∏';  // Spain
            if (h >= '380000' && h <= '3BFFFF') return 'üá´üá∑';  // France
            if (h >= '3C0000' && h <= '3FFFFF') return 'üá©üá™';  // Germany
            if (h >= '400000' && h <= '43FFFF') return 'üá¨üáß';  // United Kingdom
            if (h >= '440000' && h <= '447FFF') return 'üá¶üáπ';  // Austria
            if (h >= '448000' && h <= '44FFFF') return 'üáßüá™';  // Belgium
            if (h >= '450000' && h <= '457FFF') return 'üáßüá¨';  // Bulgaria
            if (h >= '458000' && h <= '45FFFF') return 'üá©üá∞';  // Denmark
            if (h >= '460000' && h <= '467FFF') return 'üá´üáÆ';  // Finland
            if (h >= '468000' && h <= '46FFFF') return 'üá¨üá∑';  // Greece
            if (h >= '470000' && h <= '477FFF') return 'üá≠üá∫';  // Hungary
            if (h >= '478000' && h <= '47FFFF') return 'üá≥üá¥';  // Norway
            if (h >= '480000' && h <= '487FFF') return 'üá≥üá±';  // Netherlands
            if (h >= '488000' && h <= '48FFFF') return 'üáµüá±';  // Poland
            if (h >= '490000' && h <= '497FFF') return 'üáµüáπ';  // Portugal
            if (h >= '498000' && h <= '49FFFF') return 'üá®üáø';  // Czech Republic
            if (h >= '4A0000' && h <= '4A7FFF') return 'üá∑üá¥';  // Romania
            if (h >= '4A8000' && h <= '4AFFFF') return 'üá∏üá™';  // Sweden
            if (h >= '4B0000' && h <= '4B7FFF') return 'üá®üá≠';  // Switzerland
            if (h >= '4B8000' && h <= '4BFFFF') return 'üáπüá∑';  // Turkey
            if (h >= '4C0000' && h <= '4C7FFF') return 'üá∑üá∏';  // Serbia
            if (h >= '4C8000' && h <= '4C83FF') return 'üá®üáæ';  // Cyprus
            if (h >= '4CA000' && h <= '4CAFFF') return 'üáÆüá™';  // Ireland
            if (h >= '4CC000' && h <= '4CCFFF') return 'üáÆüá∏';  // Iceland
            if (h >= '4D0000' && h <= '4D03FF') return 'üá±üá∫';  // Luxembourg
            if (h >= '4D2000' && h <= '4D23FF') return 'üá≤üáπ';  // Malta
            if (h >= '4D4000' && h <= '4D43FF') return 'üá≤üá®';  // Monaco
            if (h >= '500000' && h <= '5003FF') return 'üá∏üá≤';  // San Marino
            if (h >= '501000' && h <= '5013FF') return 'üá¶üá±';  // Albania
            if (h >= '501C00' && h <= '501FFF') return 'üá≠üá∑';  // Croatia
            if (h >= '502C00' && h <= '502FFF') return 'üá±üáª';  // Latvia
            if (h >= '503C00' && h <= '503FFF') return 'üá±üáπ';  // Lithuania
            if (h >= '504C00' && h <= '504FFF') return 'üá≤üá©';  // Moldova
            if (h >= '505C00' && h <= '505FFF') return 'üá∏üá∞';  // Slovakia
            if (h >= '506C00' && h <= '506FFF') return 'üá∏üáÆ';  // Slovenia
            if (h >= '507C00' && h <= '507FFF') return 'üá∫üáø';  // Uzbekistan
            if (h >= '508000' && h <= '50FFFF') return 'üá∫üá¶';  // Ukraine
            if (h >= '510000' && h <= '5103FF') return 'üáßüáæ';  // Belarus
            if (h >= '511000' && h <= '5113FF') return 'üá™üá™';  // Estonia
            if (h >= '512000' && h <= '5123FF') return 'üá≤üá∞';  // North Macedonia
            if (h >= '513000' && h <= '5133FF') return 'üáßüá¶';  // Bosnia and Herzegovina
            if (h >= '514000' && h <= '5143FF') return 'üá¨üá™';  // Georgia
            if (h >= '515000' && h <= '5153FF') return 'üáπüáØ';  // Tajikistan
            if (h >= '516000' && h <= '5163FF') return 'üá≤üá™';  // Montenegro
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ASIA & MIDDLE EAST (0x600000 - 0x8FFFFF)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (h >= '600000' && h <= '6003FF') return 'üá¶üá≤';  // Armenia
            if (h >= '600800' && h <= '600BFF') return 'üá¶üáø';  // Azerbaijan
            if (h >= '601000' && h <= '6013FF') return 'üá∞üá¨';  // Kyrgyzstan
            if (h >= '601800' && h <= '601BFF') return 'üáπüá≤';  // Turkmenistan
            if (h >= '680000' && h <= '6803FF') return 'üáßüáπ';  // Bhutan
            if (h >= '681000' && h <= '6813FF') return 'üá´üá≤';  // Micronesia
            if (h >= '682000' && h <= '6823FF') return 'üá≤üá≥';  // Mongolia
            if (h >= '683000' && h <= '6833FF') return 'üá∞üáø';  // Kazakhstan
            if (h >= '684000' && h <= '6843FF') return 'üáµüáº';  // Palau
            if (h >= '688000' && h <= '68FFFF') return 'üá¶üá´';  // Afghanistan
            if (h >= '690000' && h <= '6903FF') return 'üáßüá©';  // Bangladesh
            if (h >= '698000' && h <= '6983FF') return 'üá≤üá≤';  // Myanmar
            if (h >= '6A0000' && h <= '6A3FFF') return 'üá∞üáº';  // Kuwait
            if (h >= '6A8000' && h <= '6A8FFF') return 'üá±üá¶';  // Laos
            if (h >= '6B0000' && h <= '6B0FFF') return 'üá≥üáµ';  // Nepal
            if (h >= '6B8000' && h <= '6B8FFF') return 'üá¥üá≤';  // Oman
            if (h >= '6C0000' && h <= '6C0FFF') return 'üá∞üá≠';  // Cambodia
            if (h >= '6C8000' && h <= '6C8FFF') return 'üá∏üá¶';  // Saudi Arabia
            if (h >= '6D0000' && h <= '6D3FFF') return 'üá∞üá∑';  // South Korea
            if (h >= '6D8000' && h <= '6D8FFF') return 'üá∞üáµ';  // North Korea
            if (h >= '6E0000' && h <= '6E0FFF') return 'üáÆüá∂';  // Iraq
            if (h >= '6E8000' && h <= '6E8FFF') return 'üáÆüá∑';  // Iran
            if (h >= '6F0000' && h <= '6F0FFF') return 'üáÆüá±';  // Israel
            if (h >= '6F8000' && h <= '6F8FFF') return 'üáØüá¥';  // Jordan
            if (h >= '700000' && h <= '700FFF') return 'üá±üáß';  // Lebanon
            if (h >= '708000' && h <= '708FFF') return 'üá≤üáæ';  // Malaysia
            if (h >= '710000' && h <= '717FFF') return 'üáµüá≠';  // Philippines
            if (h >= '718000' && h <= '71FFFF') return 'üáµüá∞';  // Pakistan
            if (h >= '720000' && h <= '727FFF') return 'üá∏üá¨';  // Singapore
            if (h >= '728000' && h <= '72FFFF') return 'üá±üá∞';  // Sri Lanka
            if (h >= '730000' && h <= '737FFF') return 'üá∏üáæ';  // Syria
            if (h >= '738000' && h <= '73FFFF') return 'üáπüáº';  // Taiwan
            if (h >= '740000' && h <= '747FFF') return 'üáπüá≠';  // Thailand
            if (h >= '748000' && h <= '74FFFF') return 'üáªüá≥';  // Vietnam
            if (h >= '750000' && h <= '757FFF') return 'üáæüá™';  // Yemen
            if (h >= '758000' && h <= '75FFFF') return 'üáßüá≠';  // Bahrain
            if (h >= '760000' && h <= '767FFF') return 'üá¶üá™';  // UAE
            if (h >= '768000' && h <= '76FFFF') return 'üáßüá≥';  // Brunei
            if (h >= '780000' && h <= '7BFFFF') return 'üá®üá≥';  // China
            if (h >= '7C0000' && h <= '7FFFFF') return 'üá¶üá∫';  // Australia
            if (h >= '800000' && h <= '83FFFF') return 'üáÆüá≥';  // India
            if (h >= '840000' && h <= '87FFFF') return 'üáØüáµ';  // Japan
            if (h >= '880000' && h <= '887FFF') return 'üáπüá≠';  // Thailand (extended)
            if (h >= '888000' && h <= '88FFFF') return 'üáªüá≥';  // Vietnam (extended)
            if (h >= '890000' && h <= '890FFF') return 'üá≠üá∞';  // Hong Kong
            if (h >= '894000' && h <= '894FFF') return 'üá∞üáµ';  // North Korea
            if (h >= '895000' && h <= '8953FF') return 'üá≤üá¥';  // Macao
            if (h >= '896000' && h <= '896FFF') return 'üá∞üá∑';  // South Korea
            if (h >= '897000' && h <= '8973FF') return 'üá∞üá≠';  // Cambodia
            if (h >= '898000' && h <= '898FFF') return 'üáµüá≠';  // Philippines
            if (h >= '899000' && h <= '8993FF') return 'üá≤üá≥';  // Mongolia
            if (h >= '89A000' && h <= '89AFFF') return 'üáπüáº';  // Taiwan
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // NORTH AMERICA (0xA00000 - 0xCFFFFF)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (h >= 'A00000' && h <= 'AFFFFF') return 'üá∫üá∏';  // USA
            if (h >= 'C00000' && h <= 'C3FFFF') return 'üá®üá¶';  // Canada
            if (h >= 'C80000' && h <= 'C87FFF') return 'üá≥üáø';  // New Zealand
            if (h >= 'C88000' && h <= 'C88FFF') return 'üá´üáØ';  // Fiji
            if (h >= 'C8A000' && h <= 'C8AFFF') return 'üá≥üá∑';  // Nauru
            if (h >= 'C8C000' && h <= 'C8CFFF') return 'üá±üá®';  // Saint Lucia
            if (h >= 'C8E000' && h <= 'C8EFFF') return 'üáªüá∫';  // Vanuatu
            if (h >= 'C90000' && h <= 'C903FF') return 'üá∏üáß';  // Solomon Islands
            if (h >= 'C92000' && h <= 'C923FF') return 'üáµüá¨';  // Papua New Guinea
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // SOUTH AMERICA (0xE00000 - 0xEFFFFF)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (h >= 'E00000' && h <= 'E3FFFF') return 'üá¶üá∑';  // Argentina
            if (h >= 'E40000' && h <= 'E7FFFF') return 'üáßüá∑';  // Brazil
            if (h >= 'E80000' && h <= 'E80FFF') return 'üá®üá±';  // Chile
            if (h >= 'E84000' && h <= 'E84FFF') return 'üá™üá®';  // Ecuador
            if (h >= 'E88000' && h <= 'E88FFF') return 'üáµüáæ';  // Paraguay
            if (h >= 'E8C000' && h <= 'E8CFFF') return 'üáµüá™';  // Peru
            if (h >= 'E90000' && h <= 'E90FFF') return 'üá∫üáæ';  // Uruguay
            if (h >= 'E94000' && h <= 'E94FFF') return 'üáßüá¥';  // Bolivia
            
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // ICAO / INTERNATIONAL (0xF00000+)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (h >= 'F00000' && h <= 'F07FFF') return 'üåê';  // ICAO
            
            return 'üåç';  // Unknown/other
        }

        // Get freshness class based on age
        function getAgeClass(seen) {
            if (seen === undefined) return '';
            if (seen <= 10) return 'age-fresh';
            if (seen <= 30) return 'age-stale';
            if (seen <= 60) return 'age-old';
            if (seen <= 120) return 'age-lost';
            return 'age-gone';
        }

        // Callsign cache - remember callsigns even when not in current poll
        const callsignCache = {};
        
        // Units toggle
        let useMetricUnits = localStorage.getItem('useMetricUnits') === 'true';
        
        function toggleUnits() {
            useMetricUnits = !useMetricUnits;
            localStorage.setItem('useMetricUnits', useMetricUnits);
            document.getElementById('units-toggle-switch').classList.toggle('active', useMetricUnits);
            updateLiveAircraft(); // Refresh with new units
        }

        // Initialize units toggle state
        if (useMetricUnits) {
            document.getElementById('units-toggle-switch').classList.add('active');
        }

        // Update live aircraft list (table format)
        async function updateLiveAircraft() {
            try {
                const response = await fetch(`${tar1090URL}data/aircraft.json`);
                const data = await response.json();
                
                const aircraftList = document.getElementById('live-aircraft');
                const updateTime = document.getElementById('aircraft-update-time');
                const countBadge = document.getElementById('aircraft-count-badge');
                
                if (!data.aircraft || data.aircraft.length === 0) {
                    aircraftList.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No aircraft detected</div>';
                    countBadge.textContent = '0';
                    return;
                }
                
                // Filter aircraft with position and sort by distance
                const liveAircraft = data.aircraft
                    .filter(ac => (ac.flight || ac.hex) && ac.lat && ac.lon)
                    .sort((a, b) => (a.r_dst || 999) - (b.r_dst || 999))
                    .slice(0, 15);
                
                countBadge.textContent = data.aircraft.filter(ac => ac.lat && ac.lon).length;
                
                if (liveAircraft.length === 0) {
                    aircraftList.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No aircraft with position data</div>';
                    return;
                }
                
                // Units labels
                const spdLabel = useMetricUnits ? 'Spd' : 'Spd';
                const distLabel = useMetricUnits ? 'Dist' : 'Dist';
                
                // Build table
                let html = `
                    <table class="aircraft-table">
                        <thead>
                            <tr>
                                <th>Callsign</th>
                                <th>Hex</th>
                                <th>Type</th>
                                <th>Alt</th>
                                <th>${spdLabel}</th>
                                <th>Hdg</th>
                                <th>${distLabel}</th>
                                <th>Seen</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                liveAircraft.forEach(aircraft => {
                    const hex = aircraft.hex || '';
                    const flag = getCountryFlag(hex);
                    
                    // Use cached callsign if current poll doesn't have it
                    let flight = (aircraft.flight || '').trim();
                    if (flight && hex) {
                        callsignCache[hex.toLowerCase()] = flight;  // Cache it
                    } else if (!flight && hex && callsignCache[hex.toLowerCase()]) {
                        flight = callsignCache[hex.toLowerCase()];  // Use cached
                    }
                    if (!flight) flight = '‚Äî';
                    
                    // Aircraft type - try to get from tar1090 db cache, fall back to category
                    // Note: aircraft.type is SIGNAL type (adsb_icao), not aircraft type!
                    let type = '‚Äî';
                    if (aircraft.t) {
                        type = aircraft.t;  // If tar1090 enriched it
                    } else if (aircraft.desc) {
                        type = aircraft.desc;
                    } else if (aircraft.category) {
                        // Show category with meaning
                        const catMap = {
                            'A0': 'A0', 'A1': 'Light', 'A2': 'Small', 
                            'A3': 'Large', 'A4': 'B757', 'A5': 'Heavy',
                            'A6': 'Perf', 'A7': 'Rotor',
                            'B0': 'B0', 'B1': 'Glider', 'B2': 'Balloon',
                            'B3': 'Chute', 'B4': 'Ultra', 'B6': 'UAV', 'B7': 'Space',
                            'C0': 'C0', 'C1': 'Emerg', 'C2': 'Service', 'C3': 'Ground'
                        };
                        type = catMap[aircraft.category] || aircraft.category;
                    }
                    
                    // Altitude with climb/descend indicator
                    let alt = '‚Äî';
                    let altClass = '';
                    if (aircraft.alt_baro) {
                        const altVal = aircraft.alt_baro >= 10000 ? 
                            Math.round(aircraft.alt_baro / 1000) + 'k' : 
                            aircraft.alt_baro;
                        const vertRate = aircraft.baro_rate || aircraft.geom_rate || 0;
                        if (vertRate > 200) {
                            alt = `${altVal}‚ñ≤`;
                            altClass = 'climbing';
                        } else if (vertRate < -200) {
                            alt = `${altVal}‚ñº`;
                            altClass = 'descending';
                        } else {
                            alt = altVal;
                        }
                    }
                    
                    // Speed with acceleration/deceleration indicator
                    let spd = '‚Äî';
                    let spdClass = '';
                    if (aircraft.gs) {
                        const prevSpeed = prevAircraftSpeeds[hex];
                        const speedDiff = prevSpeed !== undefined ? aircraft.gs - prevSpeed : 0;
                        
                        let spdVal;
                        if (useMetricUnits) {
                            spdVal = `${Math.round(aircraft.gs * 1.15078)}mph`;
                        } else {
                            spdVal = `${Math.round(aircraft.gs)}kt`;
                        }
                        
                        // Show trend if speed changed by more than 5 knots
                        if (speedDiff > 5) {
                            spd = `${spdVal}‚ñ≤`;
                            spdClass = 'accelerating';
                        } else if (speedDiff < -5) {
                            spd = `${spdVal}‚ñº`;
                            spdClass = 'decelerating';
                        } else {
                            spd = spdVal;
                        }
                        
                        // Store current speed for next comparison
                        prevAircraftSpeeds[hex] = aircraft.gs;
                    }
                    
                    // Heading with arrow
                    let hdg = '‚Äî';
                    if (aircraft.track !== undefined) {
                        const arrows = ['‚Üë','‚Üó','‚Üí','‚Üò','‚Üì','‚Üô','‚Üê','‚Üñ'];
                        const idx = Math.round(aircraft.track / 45) % 8;
                        hdg = `${Math.round(aircraft.track)}¬∞${arrows[idx]}`;
                    }
                    
                    // Distance (nm to mi: multiply by 1.15078)
                    let dist = '‚Äî';
                    if (aircraft.r_dst) {
                        if (useMetricUnits) {
                            dist = `${(aircraft.r_dst * 1.15078).toFixed(1)}mi`;
                        } else {
                            dist = `${aircraft.r_dst.toFixed(1)}nm`;
                        }
                    }
                    
                    // Age with freshness color
                    const seenVal = aircraft.seen;
                    const ageClass = getAgeClass(seenVal);
                    const seen = seenVal !== undefined ? 
                        (seenVal < 60 ? `${Math.floor(seenVal)}s` : `${Math.floor(seenVal / 60)}m`) : 
                        '‚Äî';
                    
                    // ADSBexchange lookup URL
                    const adsbxUrl = hex ? `https://globe.adsbexchange.com/?icao=${hex}` : '#';
                    
                    html += `
                        <tr>
                            <td class="callsign">${flag} ${flight}</td>
                            <td><a href="${adsbxUrl}" target="_blank" class="hex-link" title="View on ADSBexchange">${hex || '‚Äî'}</a></td>
                            <td class="type">${type}</td>
                            <td class="${altClass}">${alt}</td>
                            <td class="${spdClass}">${spd}</td>
                            <td>${hdg}</td>
                            <td>${dist}</td>
                            <td class="${ageClass}">${seen}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                aircraftList.innerHTML = html;
                
                // Clean up old aircraft from speed tracking
                const currentHexes = new Set(liveAircraft.map(ac => ac.hex));
                Object.keys(prevAircraftSpeeds).forEach(hex => {
                    if (!currentHexes.has(hex)) {
                        delete prevAircraftSpeeds[hex];
                    }
                });
                
                const now = new Date();
                updateTime.textContent = `Updated ${now.toLocaleTimeString()}`;
            } catch (error) {
                console.error('Error fetching aircraft data:', error);
            }
        }

        // Check for updates
        async function checkForUpdates() {
            const CURRENT_VERSION = '1.2.1';
            const dismissedVersion = localStorage.getItem('dismissed-update-version');
            
            try {
                const response = await fetch('https://raw.githubusercontent.com/datboip/EasyADSB/main/VERSION');
                const remoteVersion = (await response.text()).trim();
                
                if (remoteVersion !== CURRENT_VERSION && remoteVersion !== dismissedVersion) {
                    document.getElementById('update-version').textContent = 'v' + remoteVersion;
                    document.getElementById('update-toast').classList.add('show');
                    localStorage.setItem('available-update-version', remoteVersion);
                }
            } catch (error) {
                console.log('Update check failed (offline or rate limited)');
            }
        }

        function dismissUpdate() {
            const availableVersion = localStorage.getItem('available-update-version');
            if (availableVersion) {
                localStorage.setItem('dismissed-update-version', availableVersion);
            }
            document.getElementById('update-toast').classList.remove('show');
        }

        // Initialize
        window.lastStatsUpdate = Date.now();
        updateReferenceIDs();
        updateStats();
        updateLiveAircraft(); // Initial load
        setInterval(updateStats, 5000);
        setInterval(updateLiveAircraft, 5000); // Update aircraft every 5 seconds
        
        // Check for updates on load (delayed to not slow down initial render)
        setTimeout(checkForUpdates, 3000);
        
        // Show PiAware claim message if not dismissed
        if (localStorage.getItem('piaware-claim-dismissed') !== 'true') {
            document.getElementById('piaware-claim-msg').style.display = 'block';
        }
        
        // Restore stealth mode state
        if (localStorage.getItem('stealthMode') === 'true') {
            document.body.classList.add('stealth-mode');
            document.getElementById('stealth-icon').textContent = 'üîí';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FLIGHT LOGGER FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        const LOGGER_URL = `http://${window.location.hostname}:${LOGGER_PORT}`;
        let loggerAvailable = false;
        let loggerPaused = false;
        
        async function checkLoggerStatus() {
            try {
                const response = await fetch(`${LOGGER_URL}/health`, { timeout: 3000 });
                if (response.ok) {
                    const data = await response.json();
                    loggerAvailable = true;
                    loggerPaused = data.paused;
                    
                    document.getElementById('logger-disabled').style.display = 'none';
                    document.getElementById('logger-stats').style.display = 'block';
                    
                    const statusBadge = document.getElementById('logger-status');
                    const toggleBtn = document.getElementById('logger-toggle-btn');
                    toggleBtn.disabled = false;
                    
                    if (data.paused) {
                        statusBadge.textContent = '‚è∏Ô∏è Paused';
                        statusBadge.style.background = '#ffc107';
                        toggleBtn.innerHTML = '‚ñ∂Ô∏è Resume';
                    } else {
                        statusBadge.textContent = '‚óè Recording';
                        statusBadge.style.background = '#28a745';
                        toggleBtn.innerHTML = '‚è∏Ô∏è Pause';
                    }
                    
                    await loadLoggerStats();
                } else {
                    showLoggerDisabled();
                }
            } catch (error) {
                console.log('Logger not available:', error.message);
                showLoggerDisabled();
            }
        }
        
        function showLoggerDisabled() {
            loggerAvailable = false;
            document.getElementById('logger-disabled').style.display = 'block';
            document.getElementById('logger-stats').style.display = 'none';
            document.getElementById('logger-status').textContent = 'Disabled';
            document.getElementById('logger-status').style.background = '#6c757d';
            document.getElementById('logger-toggle-btn').disabled = true;
        }
        
        async function loadLoggerStats() {
            if (!loggerAvailable) return;
            
            try {
                const response = await fetch(`${LOGGER_URL}/api/stats`);
                const stats = await response.json();
                
                // Update stats display
                document.getElementById('logger-total').textContent = formatNumber(stats.total_positions);
                document.getElementById('logger-aircraft').textContent = formatNumber(stats.unique_aircraft);
                document.getElementById('logger-flights').textContent = formatNumber(stats.unique_flights);
                document.getElementById('logger-storage').textContent = `${stats.storage_mb} MB`;
                
                // Update settings dropdowns
                document.getElementById('logger-interval').value = stats.interval;
                document.getElementById('logger-retention').value = stats.retention_days;
                
                // Update storage bar
                const usedMB = stats.storage_mb;
                const freeMB = stats.disk_free_mb;
                const totalMB = usedMB + freeMB;
                const usedPercent = totalMB > 0 ? (usedMB / totalMB * 100) : 0;
                
                document.getElementById('logger-storage-bar').style.width = `${Math.min(usedPercent, 100)}%`;
                document.getElementById('logger-storage-text').textContent = `${usedMB} MB / ${(freeMB / 1024).toFixed(1)} GB free`;
                
                // Estimate future storage
                if (stats.total_positions > 0 && stats.oldest_record && stats.newest_record) {
                    const oldestDate = new Date(stats.oldest_record);
                    const newestDate = new Date(stats.newest_record);
                    const daysCovered = Math.max(1, (newestDate - oldestDate) / (1000 * 60 * 60 * 24));
                    const mbPerDay = usedMB / daysCovered;
                    const estimate30Days = (mbPerDay * 30).toFixed(0);
                    document.getElementById('logger-estimate').textContent = `~${mbPerDay.toFixed(1)} MB/day ‚Ä¢ Est. 30 days: ~${estimate30Days} MB`;
                } else {
                    document.getElementById('logger-estimate').textContent = 'Collecting data to estimate storage...';
                }
                
                // Update date range
                if (stats.oldest_record && stats.newest_record) {
                    const oldest = new Date(stats.oldest_record).toLocaleDateString();
                    const newest = new Date(stats.newest_record).toLocaleDateString();
                    document.getElementById('logger-date-range').textContent = oldest === newest ? oldest : `${oldest} - ${newest}`;
                } else {
                    document.getElementById('logger-date-range').textContent = 'No data yet';
                }
                
            } catch (error) {
                console.error('Error loading logger stats:', error);
            }
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        async function toggleLogger() {
            if (!loggerAvailable) return;
            
            const endpoint = loggerPaused ? 'resume' : 'pause';
            try {
                const response = await fetch(`${LOGGER_URL}/api/${endpoint}`, { method: 'POST' });
                if (response.ok) {
                    await checkLoggerStatus();
                }
            } catch (error) {
                console.error('Error toggling logger:', error);
            }
        }
        
        async function saveLoggerSettings() {
            if (!loggerAvailable) return;
            
            const btn = document.getElementById('logger-save-btn');
            const status = document.getElementById('logger-save-status');
            const interval = document.getElementById('logger-interval').value;
            const retention = document.getElementById('logger-retention').value;
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Saving...';
            
            try {
                const response = await fetch(`${LOGGER_URL}/api/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        interval: parseInt(interval),
                        retention_days: parseInt(retention)
                    })
                });
                
                if (response.ok) {
                    status.innerHTML = '<span style="color: #28a745;">‚úì Settings saved!</span>';
                    btn.textContent = '‚úì Saved';
                    setTimeout(() => {
                        btn.textContent = 'üíæ Save';
                        btn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error saving logger settings:', error);
                status.innerHTML = '<span style="color: #dc3545;">‚úó Failed to save</span>';
                btn.textContent = 'üíæ Save';
                btn.disabled = false;
            }
            
            // Clear status after 5 seconds
            setTimeout(() => { status.textContent = ''; }, 5000);
        }
        
        function exportLogs(format) {
            if (!loggerAvailable) return;
            
            const endpoint = format === 'json' ? '/api/export/json' : '/api/export';
            window.location.href = `${LOGGER_URL}${endpoint}`;
        }
        
        async function clearLogs() {
            if (!loggerAvailable) return;
            
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL flight logs?\n\nThis cannot be undone!')) {
                return;
            }
            
            try {
                const response = await fetch(`${LOGGER_URL}/api/clear`, { method: 'POST' });
                if (response.ok) {
                    await loadLoggerStats();
                    alert('‚úì All logs cleared');
                }
            } catch (error) {
                console.error('Error clearing logs:', error);
                alert('Error clearing logs');
            }
        }
        
        // Initialize logger
        checkLoggerStatus();
        setInterval(checkLoggerStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>
